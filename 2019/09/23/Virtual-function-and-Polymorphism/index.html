<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Virtual function and Polymorphism · f1ower's Blog</title><meta name="description" content="Virtual function and Polymorphism - f1ower"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="f1ower's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/SmallF1ower" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Virtual function and Polymorphism</h1><div class="post-info">Sep 23, 2019</div><div class="post-content"><p>因为看懂大型项目的源码有困难，所以最近在看一些有关设计模式方面的知识;<br>在看简单工厂模式的时候遇到了以前所忽视的一些问题;  </p>
<h3 id="Object-Oriented-Programming"><a href="#Object-Oriented-Programming" class="headerlink" title="Object Oriented Programming"></a>Object Oriented Programming</h3><p>面向对象编程的三大特征：<br>1.封装;<br>2.继承;<br>3.多态;<br>封装和继承在之前使用PHP的时候经常使用，并尝到了不少甜头;<br>但是我对于多态的理解仅仅局限于类中的函数有多种形态这个字面理解;<br>然而在简单工厂模式中又实际使用到了，正是学习的好机会;  </p>
<h3 id="Virtual-function"><a href="#Virtual-function" class="headerlink" title="Virtual function"></a>Virtual function</h3><p>Cpp中有一个virtual关键字，一般情况下是用于虚函数和虚基类;<br>(其实看到virtual的第一反应是virtual machine…<br>而在实际的代码中是在一个基类中的一个函数定义里看到的;<br>所以我看了不少的师傅的博客之后自己写了一个简单的来理解;<br>但是详细的内容介绍参考：<br><a href="http://www.cplusplus.com/doc/tutorial/polymorphism/" target="_blank" rel="noopener">Polymorphism</a><br><a href="https://www.geeksforgeeks.org/virtual-function-cpp/" target="_blank" rel="noopener">Virtual Function in C++</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cout</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  Base Class have one function.</span></span><br><span class="line"><span class="comment"> *  [virtual function]say(): using iostream to output a message.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseClass</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"I'm base."</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Son Class inherits from Base Class.</span></span><br><span class="line"><span class="comment"> * say(): this function re-defined(Overriden) BaseClass::say().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SonClass</span>:</span> <span class="keyword">public</span> BaseClass</span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">say</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"I'm Son."</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">letClassSaySomething</span><span class="params">(BaseClass* p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    p-&gt;say();</span><br><span class="line">    <span class="keyword">delete</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//The argument is a pointer to a SonClass (derived class).</span></span><br><span class="line">    letClassSaySomething(<span class="keyword">new</span> SonClass());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个简单的例子的结果是：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">I&apos;m Son.</span><br></pre></td></tr></table></figure>

<p>但是如果将BaseClass中的virtual void say()去掉virtual这个关键字，<br>那么效果可能完全不一样;  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">I&apos;m base.</span><br></pre></td></tr></table></figure>

<p>原因是因为在BaseClass中已经定义好了BaseClass::say()，<br>子类继承父类之后对于原有的成员方法无法实现重写(无法发挥多态);<br>所以在实例化为对象之后调用的依旧是父类中的方法;<br>但是在父类的方法定义前加入virtual关键字表示该方法为一个虚函数，任何类只要继承该类即可对该方法进行重写以达到函数的多态特点;  </p>
<h3 id="Polymorphism"><a href="#Polymorphism" class="headerlink" title="Polymorphism"></a>Polymorphism</h3><p>实际上多态性的体现至少还有Abstract base classes，<br>但是这目前用不到所以也不必细看（实际上简单看一下就懂了</p>
<h3 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h3><p>写完这边博客之后睡下了总想知道程序内部的结构和其如何调用到子类里面的方法;<br>这让我一晚上都没有睡好，C++实际上都没有进行过简单的逆向和分析，这也正合我意;<br>我的目标是：<br>1.在子类中重写的虚函数，是怎么被调用的;<br>2.找到虚表的位置，分析虚表;<br>所以我修改了源代码，让一个子类进行多继承<br>//Remark：由于逆向很菜，所以这里重复修改了很多次;<br>//感谢我大哥processor和40kO的帮助下学到了很多技巧;<br>Source Code：  </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cout</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FClass</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">talk</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"I'm FClass::talk()."</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseClass</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"I'm BaseClass::say()."</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SonClass</span>:</span> <span class="keyword">public</span> BaseClass,<span class="keyword">public</span> FClass</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">say</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"I'm SonClass::say()."</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">talk</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"I'm SonClass::talk()."</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">letClassSaySomething</span><span class="params">(SonClass* p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    p-&gt;say();</span><br><span class="line">    p-&gt;talk();</span><br><span class="line">    <span class="keyword">delete</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SonClass* scp = <span class="keyword">new</span> SonClass();</span><br><span class="line">    letClassSaySomething(scp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%p\n"</span>,scp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用IDA去简单的进行分析一个虚函数的调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">__xt:0000000100000F40 ; Attributes: bp-based frame</span><br><span class="line">text:0000000100000F40</span><br><span class="line">text:0000000100000F40 ; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">text:0000000100000F40                 public _main</span><br><span class="line">text:0000000100000F40 _main           proc near</span><br><span class="line">text:0000000100000F40</span><br><span class="line">text:0000000100000F40 var_24          = dword ptr -24h</span><br><span class="line">text:0000000100000F40 var_20          = qword ptr -20h</span><br><span class="line">text:0000000100000F40 var_18          = qword ptr -18h</span><br><span class="line">text:0000000100000F40 var_10          = qword ptr -10h</span><br><span class="line">text:0000000100000F40 var_8           = dword ptr -8</span><br><span class="line">text:0000000100000F40 var_4           = dword ptr -4</span><br><span class="line">text:0000000100000F40</span><br><span class="line">text:0000000100000F40        push    rbp</span><br><span class="line">text:0000000100000F41        mov     rbp, rsp</span><br><span class="line">text:0000000100000F44        sub     rsp, 30h</span><br><span class="line">text:0000000100000F48        mov     [rbp+var_4], 0</span><br><span class="line">text:0000000100000F4F        mov     [rbp+var_8], edi</span><br><span class="line">text:0000000100000F52        mov     [rbp+var_10], rsi</span><br><span class="line">text:0000000100000F56        mov     edi, 10h        ; unsigned __int64</span><br><span class="line">text:0000000100000F5B        call    __Znwm          ; operator new(ulong)</span><br><span class="line">;这里是对于对象进行new的时候，返回值应该是指向这个对象的指针(姑且称之为：对象指针)</span><br><span class="line">text:0000000100000F60        xor     esi, esi        ; int</span><br><span class="line">text:0000000100000F62        mov     rdi, rax        ; void *</span><br><span class="line">text:0000000100000F65        mov     edx, 10h        ; size_t</span><br><span class="line">text:0000000100000F6A        mov     [rbp+var_20], rax</span><br><span class="line">;对象指针被转移到当年函数所在的栈中[rbp+var_20]的位置储存</span><br><span class="line">text:0000000100000F6E        call    _memset</span><br><span class="line">;由于我们的对象是new出来的，所以应该有一个清空该块内存的操作</span><br><span class="line">;然而这里的_memset是fastcall，所以我观察三个寄存器</span><br><span class="line">;rdi：对象指针</span><br><span class="line">;rsi：0</span><br><span class="line">;rdx：0x10</span><br><span class="line">;但是这里又引发了一个问题：现在的对象指针中都被清零了，而对象也new好了，那么虚表指针等储存在对象指针中的内容是多久被装载进去的呢？</span><br><span class="line">text:0000000100000F73        mov     rdi, [rbp+var_20] ; this</span><br><span class="line">;从栈中[rbp+var_20]的位置将储存的对象指针放到rdi中进行参数传值</span><br><span class="line">text:0000000100000F77        call    __ZN8SonClassC1Ev ; SonClass::SonClass(void)</span><br><span class="line">;这里是该类的默认构造函数，对象由类实例化而来</span><br><span class="line">;虽然我没有写构造函数，应该是编译器为我加上的，但是我认为应该关心一下这个函数的返回值(rax)</span><br><span class="line">text:0000000100000F7C        mov     rax, [rbp+var_20]</span><br><span class="line">;看到这里又有问题了，并没有将上一个函数的返回值(rax)储存，而是选择了直接覆盖</span><br><span class="line">;这里我很迷，在40kO和processor的指导下我理解了这种情况：可能压根上面这个call就没有返回值，谈什么储存</span><br><span class="line">text:0000000100000F80        mov     [rbp+var_18], rax</span><br><span class="line">text:0000000100000F84        mov     rdi, [rbp+var_18]</span><br><span class="line">;注意这里的传参，其实rdi中储存的就是对象指针</span><br><span class="line">text:0000000100000F88        call    __Z20letClassSaySomethingP8SonClass ; letClassSaySomething(SonClass *)</span><br><span class="line">;所以我们要跟进这个call去进行分析</span><br><span class="line">text:0000000100000F8D        mov     rsi, [rbp+var_18]</span><br><span class="line">text:0000000100000F91        lea     rdi, aP         ; &quot;%p\n&quot;</span><br><span class="line">text:0000000100000F98        mov     al, 0</span><br><span class="line">text:0000000100000F9A        call    _printf</span><br><span class="line">text:0000000100000F9F        xor     ecx, ecx</span><br><span class="line">text:0000000100000FA1        mov     [rbp+var_24], eax</span><br><span class="line">text:0000000100000FA4        mov     eax, ecx</span><br><span class="line">text:0000000100000FA6        add     rsp, 30h</span><br><span class="line">text:0000000100000FAA        pop     rbp</span><br><span class="line">text:0000000100000FAB        retn</span><br><span class="line">text:0000000100000FAB _main  endp</span><br><span class="line">text:0000000100000FAB</span><br></pre></td></tr></table></figure>

<p>跟进call</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">text:0000000100000EF0 ; Attributes: bp-based frame</span><br><span class="line">text:0000000100000EF0</span><br><span class="line">text:0000000100000EF0 ; letClassSaySomething(SonClass *)</span><br><span class="line">text:0000000100000EF0                 public __Z20letClassSaySomethingP8SonClass</span><br><span class="line">text:0000000100000EF0 __Z20letClassSaySomethingP8SonClass proc near</span><br><span class="line">text:0000000100000EF0                                         ; CODE XREF: _main+48↓p</span><br><span class="line">text:0000000100000EF0</span><br><span class="line">text:0000000100000EF0 var_18          = qword ptr -18h</span><br><span class="line">text:0000000100000EF0 var_10          = qword ptr -10h</span><br><span class="line">text:0000000100000EF0 var_8           = qword ptr -8</span><br><span class="line">text:0000000100000EF0</span><br><span class="line">text:0000000100000EF0        push    rbp</span><br><span class="line">text:0000000100000EF1        mov     rbp, rsp</span><br><span class="line">text:0000000100000EF4        sub     rsp, 20h</span><br><span class="line">text:0000000100000EF8        mov     [rbp+var_8], rdi</span><br><span class="line">;传入的参数是对象指针，将其放入该函数栈中[rbp+var_8]中储存</span><br><span class="line">text:0000000100000EFC        mov     rdi, [rbp+var_8]</span><br><span class="line">text:0000000100000F00        mov     rax, [rdi]</span><br><span class="line">;将对象指针所指向的地址中的值放入rax中</span><br><span class="line">;那么放入rax的这个值到底是什么？</span><br><span class="line">text:0000000100000F03        call    qword ptr [rax]</span><br><span class="line">;这个我能猜到rax中应该是一个指针，因为进行了访存</span><br><span class="line">;rax中应该存放的是虚表指针，为什么呢？</span><br><span class="line">;对象指针中开头应该存放了虚表指针</span><br><span class="line">;那虚表指针中又存放了一堆指针，这些指针指向实际的虚函数代码</span><br><span class="line">;以上都是我大哥processor和40kO教我的，由于我几乎不会逆向，所以我懵逼了，所以我选择进行调试</span><br><span class="line">text:0000000100000F05        mov     rax, [rbp+var_8]</span><br><span class="line">text:0000000100000F09        mov     rdi, [rax]</span><br><span class="line">text:0000000100000F0C        mov     [rbp+var_10], rdi</span><br><span class="line">text:0000000100000F10        mov     rdi, rax</span><br><span class="line">text:0000000100000F13        mov     rax, [rbp+var_10]</span><br><span class="line">text:0000000100000F17        call    qword ptr [rax+8]</span><br><span class="line">text:0000000100000F1A        mov     rax, [rbp+var_8]</span><br><span class="line">text:0000000100000F1E        cmp     rax, 0</span><br><span class="line">text:0000000100000F22        mov     [rbp+var_18], rax</span><br><span class="line">text:0000000100000F26        jz      loc_100000F38</span><br><span class="line">text:0000000100000F2C        mov     rax, [rbp+var_18]</span><br><span class="line">text:0000000100000F30        mov     rdi, rax        ; void *</span><br><span class="line">text:0000000100000F33        call    __ZdlPv         ; operator delete(void *)</span><br><span class="line">text:0000000100000F38</span><br><span class="line">text:0000000100000F38 loc_100000F38:                          ; CODE XREF: letClassSaySomething(SonClass *)+36↑j</span><br><span class="line">text:0000000100000F38        add     rsp, 20h</span><br><span class="line">text:0000000100000F3C        pop     rbp</span><br><span class="line">text:0000000100000F3D        retn</span><br><span class="line">text:0000000100000F3D __Z20letClassSaySomethingP8SonClass endp</span><br></pre></td></tr></table></figure>

<h3 id="Debugging"><a href="#Debugging" class="headerlink" title="Debugging"></a>Debugging</h3><p>首先明确调试的目标：<br>1.注意new之后的返回值<br>2.注意构造函数之后的rax<br>3.观察对象指针中的变化<br>4.画出对象指针、虚表指针中的布局，然后搞清楚他们之间的关系</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">(lldb) dis</span><br><span class="line">main @ virtual_function:</span><br><span class="line">    0x10f14cf40: push   rbp</span><br><span class="line">    0x10f14cf41: mov    rbp, rsp</span><br><span class="line">    0x10f14cf44: sub    rsp, 0x30</span><br><span class="line">    0x10f14cf48: mov    dword ptr [rbp - 0x4], 0x0</span><br><span class="line">    0x10f14cf4f: mov    dword ptr [rbp - 0x8], edi</span><br><span class="line">    0x10f14cf52: mov    qword ptr [rbp - 0x10], rsi</span><br><span class="line"><span class="meta">-&gt;</span>  0x10f14cf56: mov    edi, 0x10</span><br><span class="line">    0x10f14cf5b: call   0x10f14dd8e               ; symbol stub for: operator new(unsigned long)</span><br><span class="line">    0x10f14cf60: xor    esi, esi</span><br><span class="line">    0x10f14cf62: mov    rdi, rax</span><br><span class="line">    0x10f14cf65: mov    edx, 0x10</span><br><span class="line">    0x10f14cf6a: mov    qword ptr [rbp - 0x20], rax</span><br><span class="line">    0x10f14cf6e: call   0x10f14dda0               ; symbol stub for: memset</span><br><span class="line">    0x10f14cf73: mov    rdi, qword ptr [rbp - 0x20]</span><br><span class="line">    0x10f14cf77: call   0x10f14cfb0               ; SonClass::SonClass at main.cpp:24</span><br><span class="line">    0x10f14cf7c: mov    rax, qword ptr [rbp - 0x20]</span><br><span class="line">    0x10f14cf80: mov    qword ptr [rbp - 0x18], rax</span><br><span class="line">    0x10f14cf84: mov    rdi, qword ptr [rbp - 0x18]</span><br><span class="line">    0x10f14cf88: call   0x10f14cef0               ; letClassSaySomething at main.cpp:38</span><br><span class="line">    0x10f14cf8d: mov    rsi, qword ptr [rbp - 0x18]</span><br><span class="line">    0x10f14cf91: lea    rdi, [rip + 0xf4c]        ; "%p\n"</span><br><span class="line">    0x10f14cf98: mov    al, 0x0</span><br><span class="line">    0x10f14cf9a: call   0x10f14dda6               ; symbol stub for: printf</span><br><span class="line">    0x10f14cf9f: xor    ecx, ecx</span><br><span class="line">    0x10f14cfa1: mov    dword ptr [rbp - 0x24], eax</span><br><span class="line">    0x10f14cfa4: mov    eax, ecx</span><br><span class="line">    0x10f14cfa6: add    rsp, 0x30</span><br><span class="line">    0x10f14cfaa: pop    rbp</span><br><span class="line">    0x10f14cfab: ret    </span><br><span class="line">    0x10f14cfac: nop    dword ptr [rax]</span><br></pre></td></tr></table></figure>

<p>程序断在了new之前，跟进到call之后</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">(lldb) dis</span><br><span class="line">main @ virtual_function:</span><br><span class="line">    0x10f14cf40: push   rbp</span><br><span class="line">    0x10f14cf41: mov    rbp, rsp</span><br><span class="line">    0x10f14cf44: sub    rsp, 0x30</span><br><span class="line">    0x10f14cf48: mov    dword ptr [rbp - 0x4], 0x0</span><br><span class="line">    0x10f14cf4f: mov    dword ptr [rbp - 0x8], edi</span><br><span class="line">    0x10f14cf52: mov    qword ptr [rbp - 0x10], rsi</span><br><span class="line">    0x10f14cf56: mov    edi, 0x10</span><br><span class="line">    0x10f14cf5b: call   0x10f14dd8e               ; symbol stub for: operator new(unsigned long)</span><br><span class="line"><span class="meta">-&gt;</span>  0x10f14cf60: xor    esi, esi</span><br><span class="line">    0x10f14cf62: mov    rdi, rax</span><br><span class="line">    0x10f14cf65: mov    edx, 0x10</span><br><span class="line">    0x10f14cf6a: mov    qword ptr [rbp - 0x20], rax</span><br><span class="line">    0x10f14cf6e: call   0x10f14dda0               ; symbol stub for: memset</span><br><span class="line">    0x10f14cf73: mov    rdi, qword ptr [rbp - 0x20]</span><br><span class="line">    0x10f14cf77: call   0x10f14cfb0               ; SonClass::SonClass at main.cpp:24</span><br><span class="line">    0x10f14cf7c: mov    rax, qword ptr [rbp - 0x20]</span><br><span class="line">    0x10f14cf80: mov    qword ptr [rbp - 0x18], rax</span><br><span class="line">    0x10f14cf84: mov    rdi, qword ptr [rbp - 0x18]</span><br><span class="line">    0x10f14cf88: call   0x10f14cef0               ; letClassSaySomething at main.cpp:38</span><br><span class="line">    0x10f14cf8d: mov    rsi, qword ptr [rbp - 0x18]</span><br><span class="line">    0x10f14cf91: lea    rdi, [rip + 0xf4c]        ; "%p\n"</span><br><span class="line">    0x10f14cf98: mov    al, 0x0</span><br><span class="line">    0x10f14cf9a: call   0x10f14dda6               ; symbol stub for: printf</span><br><span class="line">    0x10f14cf9f: xor    ecx, ecx</span><br><span class="line">    0x10f14cfa1: mov    dword ptr [rbp - 0x24], eax</span><br><span class="line">    0x10f14cfa4: mov    eax, ecx</span><br><span class="line">    0x10f14cfa6: add    rsp, 0x30</span><br><span class="line">    0x10f14cfaa: pop    rbp</span><br><span class="line">    0x10f14cfab: ret    </span><br><span class="line">    0x10f14cfac: nop    dword ptr [rax]</span><br><span class="line">(lldb) register read</span><br><span class="line">General Purpose Registers:</span><br><span class="line">       rax = 0x00007ffc32402e20</span><br><span class="line">       rbx = 0x0000000000000000</span><br><span class="line">       rcx = 0x0000000000000000</span><br><span class="line">       rdx = 0x000000000000002e</span><br><span class="line">       rdi = 0x0000000000000004</span><br><span class="line">       rsi = 0x0000000000000008</span><br><span class="line">       rbp = 0x00007ffee0ab3720</span><br><span class="line">       rsp = 0x00007ffee0ab36f0</span><br><span class="line">        r8 = 0x000000000000000f</span><br><span class="line">        r9 = 0x00007ffc32400360</span><br><span class="line">       r10 = 0x0000000000000000</span><br><span class="line">       r11 = 0x0000000000000000</span><br><span class="line">       r12 = 0x0000000000000000</span><br><span class="line">       r13 = 0x0000000000000000</span><br><span class="line">       r14 = 0x0000000000000000</span><br><span class="line">       r15 = 0x0000000000000000</span><br><span class="line">       rip = 0x000000010f14cf60  virtual_function`main + 32 at main.cpp:46</span><br><span class="line">    rflags = 0x0000000000000206</span><br><span class="line">        cs = 0x000000000000002b</span><br><span class="line">        fs = 0x0000000000000000</span><br><span class="line">        gs = 0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>返回值为：0x00007ffc32402e20<br>我认为这个值就是对象指针，但是由于后面还进行了memset()<br>所以跟到构造函数前观察对象指针中的情况  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">(lldb) dis</span><br><span class="line">main @ virtual_function:</span><br><span class="line">    0x10f14cf40: push   rbp</span><br><span class="line">    0x10f14cf41: mov    rbp, rsp</span><br><span class="line">    0x10f14cf44: sub    rsp, 0x30</span><br><span class="line">    0x10f14cf48: mov    dword ptr [rbp - 0x4], 0x0</span><br><span class="line">    0x10f14cf4f: mov    dword ptr [rbp - 0x8], edi</span><br><span class="line">    0x10f14cf52: mov    qword ptr [rbp - 0x10], rsi</span><br><span class="line">    0x10f14cf56: mov    edi, 0x10</span><br><span class="line">    0x10f14cf5b: call   0x10f14dd8e               ; symbol stub for: operator new(unsigned long)</span><br><span class="line">    0x10f14cf60: xor    esi, esi</span><br><span class="line">    0x10f14cf62: mov    rdi, rax</span><br><span class="line">    0x10f14cf65: mov    edx, 0x10</span><br><span class="line">    0x10f14cf6a: mov    qword ptr [rbp - 0x20], rax</span><br><span class="line">    0x10f14cf6e: call   0x10f14dda0               ; symbol stub for: memset</span><br><span class="line">    0x10f14cf73: mov    rdi, qword ptr [rbp - 0x20]</span><br><span class="line"><span class="meta">-&gt;</span>  0x10f14cf77: call   0x10f14cfb0               ; SonClass::SonClass at main.cpp:24</span><br><span class="line">    0x10f14cf7c: mov    rax, qword ptr [rbp - 0x20]</span><br><span class="line">    0x10f14cf80: mov    qword ptr [rbp - 0x18], rax</span><br><span class="line">    0x10f14cf84: mov    rdi, qword ptr [rbp - 0x18]</span><br><span class="line">    0x10f14cf88: call   0x10f14cef0               ; letClassSaySomething at main.cpp:38</span><br><span class="line">    0x10f14cf8d: mov    rsi, qword ptr [rbp - 0x18]</span><br><span class="line">    0x10f14cf91: lea    rdi, [rip + 0xf4c]        ; "%p\n"</span><br><span class="line">    0x10f14cf98: mov    al, 0x0</span><br><span class="line">    0x10f14cf9a: call   0x10f14dda6               ; symbol stub for: printf</span><br><span class="line">    0x10f14cf9f: xor    ecx, ecx</span><br><span class="line">    0x10f14cfa1: mov    dword ptr [rbp - 0x24], eax</span><br><span class="line">    0x10f14cfa4: mov    eax, ecx</span><br><span class="line">    0x10f14cfa6: add    rsp, 0x30</span><br><span class="line">    0x10f14cfaa: pop    rbp</span><br><span class="line">    0x10f14cfab: ret    </span><br><span class="line">    0x10f14cfac: nop    dword ptr [rax]</span><br><span class="line">(lldb) memory read/20xg 0x00007ffc32402e20</span><br><span class="line">0x7ffc32402e20: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7ffc32402e30: 0x00007ffc32400600 0x0000000000000000</span><br><span class="line">0x7ffc32402e40: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7ffc32402e50: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7ffc32402e60: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7ffc32402e70: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7ffc32402e80: 0x00007fff51894984 0x00007fff7dbbdef0</span><br><span class="line">0x7ffc32402e90: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7ffc32402ea0: 0x00007fff7d975772 0x00007fff7d943fc5</span><br><span class="line">0x7ffc32402eb0: 0x00007fff4fbb35eb 0x00007fff7c1b76e3</span><br></pre></td></tr></table></figure>

<p>对象指针里面一片空白，跟进到这个call完</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">(lldb) dis</span><br><span class="line">main @ virtual_function:</span><br><span class="line">    0x10f14cf40: push   rbp</span><br><span class="line">    0x10f14cf41: mov    rbp, rsp</span><br><span class="line">    0x10f14cf44: sub    rsp, 0x30</span><br><span class="line">    0x10f14cf48: mov    dword ptr [rbp - 0x4], 0x0</span><br><span class="line">    0x10f14cf4f: mov    dword ptr [rbp - 0x8], edi</span><br><span class="line">    0x10f14cf52: mov    qword ptr [rbp - 0x10], rsi</span><br><span class="line">    0x10f14cf56: mov    edi, 0x10</span><br><span class="line">    0x10f14cf5b: call   0x10f14dd8e               ; symbol stub for: operator new(unsigned long)</span><br><span class="line">    0x10f14cf60: xor    esi, esi</span><br><span class="line">    0x10f14cf62: mov    rdi, rax</span><br><span class="line">    0x10f14cf65: mov    edx, 0x10</span><br><span class="line">    0x10f14cf6a: mov    qword ptr [rbp - 0x20], rax</span><br><span class="line">    0x10f14cf6e: call   0x10f14dda0               ; symbol stub for: memset</span><br><span class="line">    0x10f14cf73: mov    rdi, qword ptr [rbp - 0x20]</span><br><span class="line">    0x10f14cf77: call   0x10f14cfb0               ; SonClass::SonClass at main.cpp:24</span><br><span class="line"><span class="meta">-&gt;</span>  0x10f14cf7c: mov    rax, qword ptr [rbp - 0x20]</span><br><span class="line">    0x10f14cf80: mov    qword ptr [rbp - 0x18], rax</span><br><span class="line">    0x10f14cf84: mov    rdi, qword ptr [rbp - 0x18]</span><br><span class="line">    0x10f14cf88: call   0x10f14cef0               ; letClassSaySomething at main.cpp:38</span><br><span class="line">    0x10f14cf8d: mov    rsi, qword ptr [rbp - 0x18]</span><br><span class="line">    0x10f14cf91: lea    rdi, [rip + 0xf4c]        ; "%p\n"</span><br><span class="line">    0x10f14cf98: mov    al, 0x0</span><br><span class="line">    0x10f14cf9a: call   0x10f14dda6               ; symbol stub for: printf</span><br><span class="line">    0x10f14cf9f: xor    ecx, ecx</span><br><span class="line">    0x10f14cfa1: mov    dword ptr [rbp - 0x24], eax</span><br><span class="line">    0x10f14cfa4: mov    eax, ecx</span><br><span class="line">    0x10f14cfa6: add    rsp, 0x30</span><br><span class="line">    0x10f14cfaa: pop    rbp</span><br><span class="line">    0x10f14cfab: ret    </span><br><span class="line">    0x10f14cfac: nop    dword ptr [rax]</span><br><span class="line">(lldb) memory read/20xg 0x00007ffc32402e20</span><br><span class="line">0x7ffc32402e20: 0x000000010f14e118 0x000000010f14e138</span><br><span class="line">0x7ffc32402e30: 0x00007ffc32400600 0x0000000000000000</span><br><span class="line">0x7ffc32402e40: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7ffc32402e50: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7ffc32402e60: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7ffc32402e70: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7ffc32402e80: 0x00007fff51894984 0x00007fff7dbbdef0</span><br><span class="line">0x7ffc32402e90: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7ffc32402ea0: 0x00007fff7d975772 0x00007fff7d943fc5</span><br><span class="line">0x7ffc32402eb0: 0x00007fff4fbb35eb 0x00007fff7c1b76e3</span><br><span class="line">(lldb) register read</span><br><span class="line">General Purpose Registers:</span><br><span class="line">       rax = 0x000000010f14e118  virtual_function`vtable for SonClass + 16</span><br><span class="line">       rbx = 0x0000000000000000</span><br><span class="line">       rcx = 0x00007ffc32402e20</span><br><span class="line">       rdx = 0x0000000000000000</span><br><span class="line">       rdi = 0x000000010f14e138  virtual_function`vtable for SonClass + 48</span><br><span class="line">       rsi = 0x0000000000000000</span><br><span class="line">       rbp = 0x00007ffee0ab3720</span><br><span class="line">       rsp = 0x00007ffee0ab36f0</span><br><span class="line">        r8 = 0x000000000000000f</span><br><span class="line">        r9 = 0x00007ffc32400360</span><br><span class="line">       r10 = 0x00007ffee0ab3870</span><br><span class="line">       r11 = 0x00007fff7db798e0  libsystem_platform.dylib`_platform_memset$VARIANT$Haswell</span><br><span class="line">       r12 = 0x0000000000000000</span><br><span class="line">       r13 = 0x0000000000000000</span><br><span class="line">       r14 = 0x0000000000000000</span><br><span class="line">       r15 = 0x0000000000000000</span><br><span class="line">       rip = 0x000000010f14cf7c  virtual_function`main + 60 at main.cpp:46</span><br><span class="line">    rflags = 0x0000000000000202</span><br><span class="line">        cs = 0x000000000000002b</span><br><span class="line">        fs = 0x0000000000000000</span><br><span class="line">        gs = 0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>首先，我们已经明确了这个函数并没有返回值，所以根本不存在rax是返回值这个说法<br>顶多算作函数内部使用了rax而没有恢复寄存器到调用前的状态<br>而执行了这个call之后，对象指针中出现了另一个指针，这个指针按照之前的静态分析，应该就是虚表指针<br>那么我们直接跟进到调用letClassSaySomething函数前，查看其寄存器观察参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">(lldb) dis</span><br><span class="line">main @ virtual_function:</span><br><span class="line">    0x10f14cf40: push   rbp</span><br><span class="line">    0x10f14cf41: mov    rbp, rsp</span><br><span class="line">    0x10f14cf44: sub    rsp, 0x30</span><br><span class="line">    0x10f14cf48: mov    dword ptr [rbp - 0x4], 0x0</span><br><span class="line">    0x10f14cf4f: mov    dword ptr [rbp - 0x8], edi</span><br><span class="line">    0x10f14cf52: mov    qword ptr [rbp - 0x10], rsi</span><br><span class="line">    0x10f14cf56: mov    edi, 0x10</span><br><span class="line">    0x10f14cf5b: call   0x10f14dd8e               ; symbol stub for: operator new(unsigned long)</span><br><span class="line">    0x10f14cf60: xor    esi, esi</span><br><span class="line">    0x10f14cf62: mov    rdi, rax</span><br><span class="line">    0x10f14cf65: mov    edx, 0x10</span><br><span class="line">    0x10f14cf6a: mov    qword ptr [rbp - 0x20], rax</span><br><span class="line">    0x10f14cf6e: call   0x10f14dda0               ; symbol stub for: memset</span><br><span class="line">    0x10f14cf73: mov    rdi, qword ptr [rbp - 0x20]</span><br><span class="line">    0x10f14cf77: call   0x10f14cfb0               ; SonClass::SonClass at main.cpp:24</span><br><span class="line">    0x10f14cf7c: mov    rax, qword ptr [rbp - 0x20]</span><br><span class="line">    0x10f14cf80: mov    qword ptr [rbp - 0x18], rax</span><br><span class="line">    0x10f14cf84: mov    rdi, qword ptr [rbp - 0x18]</span><br><span class="line"><span class="meta">-&gt;</span>  0x10f14cf88: call   0x10f14cef0               ; letClassSaySomething at main.cpp:38</span><br><span class="line">    0x10f14cf8d: mov    rsi, qword ptr [rbp - 0x18]</span><br><span class="line">    0x10f14cf91: lea    rdi, [rip + 0xf4c]        ; "%p\n"</span><br><span class="line">    0x10f14cf98: mov    al, 0x0</span><br><span class="line">    0x10f14cf9a: call   0x10f14dda6               ; symbol stub for: printf</span><br><span class="line">    0x10f14cf9f: xor    ecx, ecx</span><br><span class="line">    0x10f14cfa1: mov    dword ptr [rbp - 0x24], eax</span><br><span class="line">    0x10f14cfa4: mov    eax, ecx</span><br><span class="line">    0x10f14cfa6: add    rsp, 0x30</span><br><span class="line">    0x10f14cfaa: pop    rbp</span><br><span class="line">    0x10f14cfab: ret    </span><br><span class="line">    0x10f14cfac: nop    dword ptr [rax]</span><br><span class="line">(lldb) register read</span><br><span class="line">General Purpose Registers:</span><br><span class="line">       rax = 0x00007ffc32402e20</span><br><span class="line">       rbx = 0x0000000000000000</span><br><span class="line">       rcx = 0x00007ffc32402e20</span><br><span class="line">       rdx = 0x0000000000000000</span><br><span class="line">       rdi = 0x00007ffc32402e20</span><br><span class="line">       rsi = 0x0000000000000000</span><br><span class="line">       rbp = 0x00007ffee0ab3720</span><br><span class="line">       rsp = 0x00007ffee0ab36f0</span><br><span class="line">        r8 = 0x000000000000000f</span><br><span class="line">        r9 = 0x00007ffc32400360</span><br><span class="line">       r10 = 0x00007ffee0ab3870</span><br><span class="line">       r11 = 0x00007fff7db798e0  libsystem_platform.dylib`_platform_memset$VARIANT$Haswell</span><br><span class="line">       r12 = 0x0000000000000000</span><br><span class="line">       r13 = 0x0000000000000000</span><br><span class="line">       r14 = 0x0000000000000000</span><br><span class="line">       r15 = 0x0000000000000000</span><br><span class="line">       rip = 0x000000010f14cf88  virtual_function`main + 72 at main.cpp:47</span><br><span class="line">    rflags = 0x0000000000000202</span><br><span class="line">        cs = 0x000000000000002b</span><br><span class="line">        fs = 0x0000000000000000</span><br><span class="line">        gs = 0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>这里已经可以证明刚才new之后的返回值是指向对象的指针<br>那么我还想看到虚函数是怎么被调用的，我步进这个函数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(lldb) dis</span><br><span class="line">letClassSaySomething @ virtual_function:</span><br><span class="line"><span class="meta">-&gt;</span>  0x10f14cef0: push   rbp</span><br><span class="line">    0x10f14cef1: mov    rbp, rsp</span><br><span class="line">    0x10f14cef4: sub    rsp, 0x20</span><br><span class="line">    0x10f14cef8: mov    qword ptr [rbp - 0x8], rdi</span><br><span class="line">    0x10f14cefc: mov    rdi, qword ptr [rbp - 0x8]</span><br><span class="line">    0x10f14cf00: mov    rax, qword ptr [rdi]</span><br><span class="line">    0x10f14cf03: call   qword ptr [rax]</span><br><span class="line">    0x10f14cf05: mov    rax, qword ptr [rbp - 0x8]</span><br><span class="line">    0x10f14cf09: mov    rdi, qword ptr [rax]</span><br><span class="line">    0x10f14cf0c: mov    qword ptr [rbp - 0x10], rdi</span><br><span class="line">    0x10f14cf10: mov    rdi, rax</span><br><span class="line">    0x10f14cf13: mov    rax, qword ptr [rbp - 0x10]</span><br><span class="line">    0x10f14cf17: call   qword ptr [rax + 0x8]</span><br><span class="line">    0x10f14cf1a: mov    rax, qword ptr [rbp - 0x8]</span><br><span class="line">    0x10f14cf1e: cmp    rax, 0x0</span><br><span class="line">    0x10f14cf22: mov    qword ptr [rbp - 0x18], rax</span><br><span class="line">    0x10f14cf26: je     0x10f14cf38               ; &lt;+72&gt; at main.cpp:42</span><br><span class="line">    0x10f14cf2c: mov    rax, qword ptr [rbp - 0x18]</span><br><span class="line">    0x10f14cf30: mov    rdi, rax</span><br><span class="line">    0x10f14cf33: call   0x10f14dd88               ; symbol stub for: operator delete(void*)</span><br><span class="line">    0x10f14cf38: add    rsp, 0x20</span><br><span class="line">    0x10f14cf3c: pop    rbp</span><br><span class="line">    0x10f14cf3d: ret    </span><br><span class="line">    0x10f14cf3e: nop</span><br></pre></td></tr></table></figure>

<p>和刚才静态分析的几乎没有偏差，主要分析一下最后一条mov指令<br>mov    rax, qword ptr [rdi]<br>//rdi中存放着对象指针<br>//对象指针指向的内存中存放的应该又是另一个指针(虚表指针)<br>我们跟进到最后一条mov之前：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">(lldb) dis</span><br><span class="line">letClassSaySomething @ virtual_function:</span><br><span class="line">    0x10f14cef0: push   rbp</span><br><span class="line">    0x10f14cef1: mov    rbp, rsp</span><br><span class="line">    0x10f14cef4: sub    rsp, 0x20</span><br><span class="line">    0x10f14cef8: mov    qword ptr [rbp - 0x8], rdi</span><br><span class="line">    0x10f14cefc: mov    rdi, qword ptr [rbp - 0x8]</span><br><span class="line"><span class="meta">-&gt;</span>  0x10f14cf00: mov    rax, qword ptr [rdi]</span><br><span class="line">    0x10f14cf03: call   qword ptr [rax]</span><br><span class="line">    0x10f14cf05: mov    rax, qword ptr [rbp - 0x8]</span><br><span class="line">    0x10f14cf09: mov    rdi, qword ptr [rax]</span><br><span class="line">    0x10f14cf0c: mov    qword ptr [rbp - 0x10], rdi</span><br><span class="line">    0x10f14cf10: mov    rdi, rax</span><br><span class="line">    0x10f14cf13: mov    rax, qword ptr [rbp - 0x10]</span><br><span class="line">    0x10f14cf17: call   qword ptr [rax + 0x8]</span><br><span class="line">    0x10f14cf1a: mov    rax, qword ptr [rbp - 0x8]</span><br><span class="line">    0x10f14cf1e: cmp    rax, 0x0</span><br><span class="line">    0x10f14cf22: mov    qword ptr [rbp - 0x18], rax</span><br><span class="line">    0x10f14cf26: je     0x10f14cf38               ; &lt;+72&gt; at main.cpp:42</span><br><span class="line">    0x10f14cf2c: mov    rax, qword ptr [rbp - 0x18]</span><br><span class="line">    0x10f14cf30: mov    rdi, rax</span><br><span class="line">    0x10f14cf33: call   0x10f14dd88               ; symbol stub for: operator delete(void*)</span><br><span class="line">    0x10f14cf38: add    rsp, 0x20</span><br><span class="line">    0x10f14cf3c: pop    rbp</span><br><span class="line">    0x10f14cf3d: ret    </span><br><span class="line">    0x10f14cf3e: nop    </span><br><span class="line">(lldb) register read</span><br><span class="line">General Purpose Registers:</span><br><span class="line">       rax = 0x00007ffc32402e20</span><br><span class="line">       rbx = 0x0000000000000000</span><br><span class="line">       rcx = 0x00007ffc32402e20</span><br><span class="line">       rdx = 0x0000000000000000</span><br><span class="line">       rdi = 0x00007ffc32402e20</span><br><span class="line">       rsi = 0x0000000000000000</span><br><span class="line">       rbp = 0x00007ffee0ab36e0</span><br><span class="line">       rsp = 0x00007ffee0ab36c0</span><br><span class="line">        r8 = 0x000000000000000f</span><br><span class="line">        r9 = 0x00007ffc32400360</span><br><span class="line">       r10 = 0x00007ffee0ab3870</span><br><span class="line">       r11 = 0x00007fff7db798e0  libsystem_platform.dylib\`_platform_memset$VARIANT$Haswell</span><br><span class="line">       r12 = 0x0000000000000000</span><br><span class="line">       r13 = 0x0000000000000000</span><br><span class="line">       r14 = 0x0000000000000000</span><br><span class="line">       r15 = 0x0000000000000000</span><br><span class="line">       rip = 0x000000010f14cf00  virtual_function\`letClassSaySomething(SonClass*) + 16 at main.cpp:39</span><br><span class="line">    rflags = 0x0000000000000206</span><br><span class="line">        cs = 0x000000000000002b</span><br><span class="line">        fs = 0x0000000000000000</span><br><span class="line">        gs = 0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>rdi是对象指针，我们先来看看对象指针中的值进行分析</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(lldb) memory read/20xg 0x00007ffc32402e20</span><br><span class="line">0x7ffc32402e20: 0x000000010f14e118 0x000000010f14e138</span><br><span class="line">0x7ffc32402e30: 0x00007ffc32400600 0x0000000000000000</span><br><span class="line">0x7ffc32402e40: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7ffc32402e50: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7ffc32402e60: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7ffc32402e70: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7ffc32402e80: 0x00007fff51894984 0x00007fff7dbbdef0</span><br><span class="line">0x7ffc32402e90: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x7ffc32402ea0: 0x00007fff7d975772 0x00007fff7d943fc5</span><br><span class="line">0x7ffc32402eb0: 0x00007fff4fbb35eb 0x00007fff7c1b76e3</span><br><span class="line">(lldb) memory read/20xg 0x000000010f14e118</span><br><span class="line">0x10f14e118: 0x000000010f14d070 0x000000010f14d0b0</span><br><span class="line">0x10f14e128: 0xfffffffffffffff8 0x000000010f14e160</span><br><span class="line">0x10f14e138: 0x000000010f14d0f0 0x00007fffb396bcb8</span><br><span class="line">0x10f14e148: 0x000000010f14df47 0x00007fffb396bcb8</span><br><span class="line">0x10f14e158: 0x000000010f14df52 0x00007fffb396bd98</span><br><span class="line">0x10f14e168: 0x000000010f14df3d 0x0000000200000000</span><br><span class="line">0x10f14e178: 0x000000010f14e140 0x0000000000000002</span><br><span class="line">0x10f14e188: 0x000000010f14e150 0x0000000000000802</span><br><span class="line">0x10f14e198: 0x0000000000000000 0x000000010f14e140</span><br><span class="line">0x10f14e1a8: 0x000000010f14d110 0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>那么可以明确，rax的值就是虚表指针，指向一个虚表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">(lldb) dis</span><br><span class="line">letClassSaySomething @ virtual_function:</span><br><span class="line">    0x10f14cef0: push   rbp</span><br><span class="line">    0x10f14cef1: mov    rbp, rsp</span><br><span class="line">    0x10f14cef4: sub    rsp, 0x20</span><br><span class="line">    0x10f14cef8: mov    qword ptr [rbp - 0x8], rdi</span><br><span class="line">    0x10f14cefc: mov    rdi, qword ptr [rbp - 0x8]</span><br><span class="line"><span class="meta">-&gt;</span>  0x10f14cf00: mov    rax, qword ptr [rdi]</span><br><span class="line">    0x10f14cf03: call   qword ptr [rax]</span><br><span class="line">    0x10f14cf05: mov    rax, qword ptr [rbp - 0x8]</span><br><span class="line">    0x10f14cf09: mov    rdi, qword ptr [rax]</span><br><span class="line">    0x10f14cf0c: mov    qword ptr [rbp - 0x10], rdi</span><br><span class="line">    0x10f14cf10: mov    rdi, rax</span><br><span class="line">    0x10f14cf13: mov    rax, qword ptr [rbp - 0x10]</span><br><span class="line">    0x10f14cf17: call   qword ptr [rax + 0x8]</span><br><span class="line">    0x10f14cf1a: mov    rax, qword ptr [rbp - 0x8]</span><br><span class="line">    0x10f14cf1e: cmp    rax, 0x0</span><br><span class="line">    0x10f14cf22: mov    qword ptr [rbp - 0x18], rax</span><br><span class="line">    0x10f14cf26: je     0x10f14cf38               ; &lt;+72&gt; at main.cpp:42</span><br><span class="line">    0x10f14cf2c: mov    rax, qword ptr [rbp - 0x18]</span><br><span class="line">    0x10f14cf30: mov    rdi, rax</span><br><span class="line">    0x10f14cf33: call   0x10f14dd88               ; symbol stub for: operator delete(void*)</span><br><span class="line">    0x10f14cf38: add    rsp, 0x20</span><br><span class="line">    0x10f14cf3c: pop    rbp</span><br><span class="line">    0x10f14cf3d: ret    </span><br><span class="line">    0x10f14cf3e: nop    </span><br><span class="line">(lldb) ni</span><br><span class="line">(lldb) register read</span><br><span class="line">General Purpose Registers:</span><br><span class="line">       rax = 0x000000010f14e118  virtual_function\`vtable for SonClass + 16</span><br><span class="line">       rbx = 0x0000000000000000</span><br><span class="line">       rcx = 0x00007ffc32402e20</span><br><span class="line">       rdx = 0x0000000000000000</span><br><span class="line">       rdi = 0x00007ffc32402e20</span><br><span class="line">       rsi = 0x0000000000000000</span><br><span class="line">       rbp = 0x00007ffee0ab36e0</span><br><span class="line">       rsp = 0x00007ffee0ab36c0</span><br><span class="line">        r8 = 0x000000000000000f</span><br><span class="line">        r9 = 0x00007ffc32400360</span><br><span class="line">       r10 = 0x00007ffee0ab3870</span><br><span class="line">       r11 = 0x00007fff7db798e0  libsystem_platform.dylib\`_platform_memset$VARIANT$Haswell</span><br><span class="line">       r12 = 0x0000000000000000</span><br><span class="line">       r13 = 0x0000000000000000</span><br><span class="line">       r14 = 0x0000000000000000</span><br><span class="line">       r15 = 0x0000000000000000</span><br><span class="line">       rip = 0x000000010f14cf03  virtual_function letClassSaySomething(SonClass*) + 19 at main.cpp:39</span><br><span class="line">    rflags = 0x0000000000000206</span><br><span class="line">        cs = 0x000000000000002b</span><br><span class="line">        fs = 0x0000000000000000</span><br><span class="line">        gs = 0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>然而最终是对虚表指针所指向的内存中的值(虚表内容)进行调用<br>那么虚表指针所指向的内存中的值也是一堆指针，我们先去看看这些指针指向的内存是否为代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">(lldb) memory read/20xg 0x000000010f14e118</span><br><span class="line">0x10f14e118: 0x000000010f14d070 0x000000010f14d0b0</span><br><span class="line">0x10f14e128: 0xfffffffffffffff8 0x000000010f14e160</span><br><span class="line">0x10f14e138: 0x000000010f14d0f0 0x00007fffb396bcb8</span><br><span class="line">0x10f14e148: 0x000000010f14df47 0x00007fffb396bcb8</span><br><span class="line">0x10f14e158: 0x000000010f14df52 0x00007fffb396bd98</span><br><span class="line">0x10f14e168: 0x000000010f14df3d 0x0000000200000000</span><br><span class="line">0x10f14e178: 0x000000010f14e140 0x0000000000000002</span><br><span class="line">0x10f14e188: 0x000000010f14e150 0x0000000000000802</span><br><span class="line">0x10f14e198: 0x0000000000000000 0x000000010f14e140</span><br><span class="line">0x10f14e1a8: 0x000000010f14d110 0x0000000000000000</span><br><span class="line">(lldb) x/20i 0x000000010f14d070</span><br><span class="line">    0x10f14d070: 55                    push   rbp</span><br><span class="line">    0x10f14d071: 48 89 e5              mov    rbp, rsp</span><br><span class="line">    0x10f14d074: 48 83 ec 10           sub    rsp, 0x10</span><br><span class="line">    0x10f14d078: 48 8b 05 89 0f 00 00  mov    rax, qword ptr [rip + 0xf89] ; (void *)0x00007fffb3966770: std::__1::cout</span><br><span class="line">    0x10f14d07f: 48 89 7d f8           mov    qword ptr [rbp - 0x8], rdi</span><br><span class="line">    0x10f14d083: 48 89 c7              mov    rdi, rax</span><br><span class="line">    0x10f14d086: 48 8d 35 85 0e 00 00  lea    rsi, [rip + 0xe85]        ; "I'm SonClass::say()."</span><br><span class="line">    0x10f14d08d: e8 ea 0c 00 00        call   0x10f14dd7c               ; symbol stub for: std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt; &gt;&amp; std::__1::operator&lt;&lt;&lt;std::__1::char_traits&lt;char&gt; &gt;(std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt; &gt;&amp;, char const*)</span><br><span class="line">    0x10f14d092: 48 89 c7              mov    rdi, rax</span><br><span class="line">    0x10f14d095: 48 8d 35 24 01 00 00  lea    rsi, [rip + 0x124]        ; std::__1::endl&lt;char, std::__1::char_traits&lt;char&gt; &gt; at ostream:1001</span><br><span class="line">    0x10f14d09c: e8 ff 00 00 00        call   0x10f14d1a0               </span><br><span class="line">    0x10f14d0a1: 48 89 45 f0           mov    qword ptr [rbp - 0x10], rax</span><br><span class="line">    0x10f14d0a5: 48 83 c4 10           add    rsp, 0x10</span><br><span class="line">    0x10f14d0a9: 5d                    pop    rbp</span><br><span class="line">    0x10f14d0aa: c3                    ret    </span><br><span class="line">    0x10f14d0ab: 0f 1f 44 00 00        nop    dword ptr [rax + rax]</span><br><span class="line">    0x10f14d0b0: 55                    push   rbp</span><br><span class="line">    0x10f14d0b1: 48 89 e5              mov    rbp, rsp</span><br><span class="line">    0x10f14d0b4: 48 83 ec 10           sub    rsp, 0x10</span><br><span class="line">    0x10f14d0b8: 48 8b 05 49 0f 00 00  mov    rax, qword ptr [rip + 0xf49] ; (void *)0x00007fffb3966770: std::__1::cout</span><br></pre></td></tr></table></figure>

<p>确实没有错，这里就是我们的调用的第一个虚函数的位置<br>那我们就可以确定，call之前的rax存放的就是虚表指针<br>但是看源代码中，我们一共调用了两个虚函数，还有一个应该是talk()<br>我去看看虚表中的第二个指针所指向的内存中的内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(lldb) x/20i 0x000000010f14d0b0</span><br><span class="line">    0x10f14d0b0: 55                    push   rbp</span><br><span class="line">    0x10f14d0b1: 48 89 e5              mov    rbp, rsp</span><br><span class="line">    0x10f14d0b4: 48 83 ec 10           sub    rsp, 0x10</span><br><span class="line">    0x10f14d0b8: 48 8b 05 49 0f 00 00  mov    rax, qword ptr [rip + 0xf49] ; (void *)0x00007fffb3966770: std::__1::cout</span><br><span class="line">    0x10f14d0bf: 48 89 7d f8           mov    qword ptr [rbp - 0x8], rdi</span><br><span class="line">    0x10f14d0c3: 48 89 c7              mov    rdi, rax</span><br><span class="line">    0x10f14d0c6: 48 8d 35 5a 0e 00 00  lea    rsi, [rip + 0xe5a]        ; "I'm SonClass::talk()."</span><br><span class="line">    0x10f14d0cd: e8 aa 0c 00 00        call   0x10f14dd7c               ; symbol stub for: std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt; &gt;&amp; std::__1::operator&lt;&lt;&lt;std::__1::char_traits&lt;char&gt; &gt;(std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt; &gt;&amp;, char const*)</span><br><span class="line">    0x10f14d0d2: 48 89 c7              mov    rdi, rax</span><br><span class="line">    0x10f14d0d5: 48 8d 35 e4 00 00 00  lea    rsi, [rip + 0xe4]         ; std::__1::endl&lt;char, std::__1::char_traits&lt;char&gt; &gt; at ostream:1001</span><br><span class="line">    0x10f14d0dc: e8 bf 00 00 00        call   0x10f14d1a0               </span><br><span class="line">    0x10f14d0e1: 48 89 45 f0           mov    qword ptr [rbp - 0x10], rax</span><br><span class="line">    0x10f14d0e5: 48 83 c4 10           add    rsp, 0x10</span><br><span class="line">    0x10f14d0e9: 5d                    pop    rbp</span><br><span class="line">    0x10f14d0ea: c3                    ret    </span><br><span class="line">    0x10f14d0eb: 0f 1f 44 00 00        nop    dword ptr [rax + rax]</span><br><span class="line">    0x10f14d0f0: 55                    push   rbp</span><br><span class="line">    0x10f14d0f1: 48 89 e5              mov    rbp, rsp</span><br><span class="line">    0x10f14d0f4: 48 89 7d f8           mov    qword ptr [rbp - 0x8], rdi</span><br><span class="line">    0x10f14d0f8: 48 8b 7d f8           mov    rdi, qword ptr [rbp - 0x8]</span><br></pre></td></tr></table></figure>

<p>没有什么问题，这个类的虚函数<br>跟进到下一次call虚函数之前</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">(lldb) dis</span><br><span class="line">letClassSaySomething @ virtual_function:</span><br><span class="line">    0x10f14cef0: push   rbp</span><br><span class="line">    0x10f14cef1: mov    rbp, rsp</span><br><span class="line">    0x10f14cef4: sub    rsp, 0x20</span><br><span class="line">    0x10f14cef8: mov    qword ptr [rbp - 0x8], rdi</span><br><span class="line">    0x10f14cefc: mov    rdi, qword ptr [rbp - 0x8]</span><br><span class="line">    0x10f14cf00: mov    rax, qword ptr [rdi]</span><br><span class="line">    0x10f14cf03: call   qword ptr [rax]</span><br><span class="line">    0x10f14cf05: mov    rax, qword ptr [rbp - 0x8]</span><br><span class="line">    0x10f14cf09: mov    rdi, qword ptr [rax]</span><br><span class="line">    0x10f14cf0c: mov    qword ptr [rbp - 0x10], rdi</span><br><span class="line">    0x10f14cf10: mov    rdi, rax</span><br><span class="line">    0x10f14cf13: mov    rax, qword ptr [rbp - 0x10]</span><br><span class="line"><span class="meta">-&gt;</span>  0x10f14cf17: call   qword ptr [rax + 0x8]</span><br><span class="line">    0x10f14cf1a: mov    rax, qword ptr [rbp - 0x8]</span><br><span class="line">    0x10f14cf1e: cmp    rax, 0x0</span><br><span class="line">    0x10f14cf22: mov    qword ptr [rbp - 0x18], rax</span><br><span class="line">    0x10f14cf26: je     0x10f14cf38               ; &lt;+72&gt; at main.cpp:42</span><br><span class="line">    0x10f14cf2c: mov    rax, qword ptr [rbp - 0x18]</span><br><span class="line">    0x10f14cf30: mov    rdi, rax</span><br><span class="line">    0x10f14cf33: call   0x10f14dd88               ; symbol stub for: operator delete(void*)</span><br><span class="line">    0x10f14cf38: add    rsp, 0x20</span><br><span class="line">    0x10f14cf3c: pop    rbp</span><br><span class="line">    0x10f14cf3d: ret    </span><br><span class="line">    0x10f14cf3e: nop    </span><br><span class="line">(lldb) register read</span><br><span class="line">General Purpose Registers:</span><br><span class="line">       rax = 0x000000010f14e118  virtual_function\`vtable for SonClass + 16</span><br><span class="line">       rbx = 0x0000000000000000</span><br><span class="line">       rcx = 0x00007fffb3966770  libc++.1.dylib\`std::__1::cout</span><br><span class="line">       rdx = 0x0000000000000000</span><br><span class="line">       rdi = 0x00007ffc32402e20</span><br><span class="line">       rsi = 0x00000000000120a8</span><br><span class="line">       rbp = 0x00007ffee0ab36e0</span><br><span class="line">       rsp = 0x00007ffee0ab36c0</span><br><span class="line">        r8 = 0x00000000000130a8</span><br><span class="line">        r9 = 0x00007fffb421ff78  __sFX + 248</span><br><span class="line">       r10 = 0x0000000000000000</span><br><span class="line">       r11 = 0x00007fffb421ff70  __sFX + 240</span><br><span class="line">       r12 = 0x0000000000000000</span><br><span class="line">       r13 = 0x0000000000000000</span><br><span class="line">       r14 = 0x0000000000000000</span><br><span class="line">       r15 = 0x0000000000000000</span><br><span class="line">       rip = 0x000000010f14cf17  virtual_function\`letClassSaySomething(SonClass*) + 39 at main.cpp:40</span><br><span class="line">    rflags = 0x0000000000000202</span><br><span class="line">        cs = 0x000000000000002b</span><br><span class="line">        fs = 0x0000000000000000</span><br><span class="line">        gs = 0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>rax中还是虚表指针，而这一次的call，是找到虚表指针所指向的内存中的第二个指针(第二个虚函数)，直接调用<br>由于刚才看了源代码，所以不再需要去看了<br>总结一下：<br>1.new之后的返回值就是对象指针<br>2.构造函数之后的rax其实是虚表指针，但并不是返回值，只是构造函数中用到了rax而已<br>3.对象在new出来之后返回对象指针，对象指针所指向的内存会被memset清空;而在类构造函数中，会将该类的虚表指针放入对象指针所指向的内存中+0的位置，便于后面调用虚函数的时候可以直接从对象指针中取到虚表指针，从而得到每一个虚函数的实际内存地址并call过去<br>4.下面我画出对象指针、虚表指针中的布局和关系图：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x00007ffc32402e20(new的返回值/对象指针) --&gt; 0x7ffc32402e20: 0x000000010f14e118(虚表指针) 0x000000010f14e138</span><br><span class="line">0x000000010f14e118(虚表指针) --&gt; 0x10f14e118: 0x000000010f14d070(虚函数1的指针) 0x000000010f14d0b0(虚函数2的指针)</span><br></pre></td></tr></table></figure>

<p>由于我在程序中加入了一个printf函数用于检验fcp这个指针的值，所以直接c掉查看命令行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">I'm SonClass::say().</span><br><span class="line">I'm SonClass::talk().</span><br><span class="line">0x7ffc32402e20</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure>

<p>我自己分析出来的SonClass的虚表中的虚函数排列是这样的：<br>–low addr–<br>SonClass::say()<br>SonClass::talk();<br>–high addr–<br>和调用的顺序是一样的<br>我还需要在IDA里面找到虚表对照一下验证我自己通过逆向分析的虚表是否正确<br>IDA找到SonClass::say()或者SonClass::talk()，直接查看交叉引用<br>//由于IDA中会有特殊符号导致markdown中代码块语法出现问题，所以有些注释我直接删除了<br>//虚表复制到markdown格式里面有挺多的问题，不想搞，所以就只取了最重要的部分贴过来<br>const:0000000100002118 dq offset __ZN8SonClass3sayEv ; SonClass::say(void)<br>const:0000000100002120 dq offset __ZN8SonClass4talkEv ; SonClass::talk(void)<br>确实如我所分析的那样</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>虽然踩了挺多坑，但是也差不多搞明白了：<br>1.对象中虚函数的调用方式<br>2.如何找到一个类的虚表</p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/11/14/Simple-mips-stackoverflow/" class="prev">PREV</a><a href="/2019/09/21/Blog-again/" class="next">NEXT</a></div><div class="copyright"><p>© 2019 - 2020 <a href="http://yoursite.com">f1ower</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>